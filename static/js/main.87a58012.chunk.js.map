{"version":3,"sources":["index.js"],"names":["book","undefined","book_chapters","str","JSON","parse","i","chapters","push","key","value","data","name","marks","load_book","popups","vwidth","document","documentElement","clientWidth","sleep","ms","a","Promise","resolve","setTimeout","mapStyle","height","clientHeight","width","curr_point","L","latLng","curr_z","Map","props","pause","persons","play","bind","first","length","datablock","this","remove","point","mymap","getBounds","contains","flyTo","popup","setLatLng","setContent","openOn","then","shift","id","style","map","setView","setMaxBounds","latLngBounds","tileLayer","minZoom","maxZoom","updateWhenZooming","updateWhenIdle","bounds","accessToken","addTo","getCenter","getZoom","React","App","state","activeStory","activeScreen","activePanelChapter","activeChapter","MarksInChapter","onStoryChange","onIntroClick","onChapterCellClick","onMarkCellClick","e","setState","currentTarget","dataset","story","index","buf","forEach","mark","mark_id","found","element","activeView","paddingTop","paddingBottom","color","textAlign","verticalAlign","size","mode","onClick","tabbar","selected","data-story","text","activePanel","Array","prototype","call","chapter_struct","expandable","mark_name","expandble","ReactDOM","render","getElementById"],"mappings":"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","file":"static/js/main.87a58012.chunk.js","sourcesContent":["import * as React from 'react';\nimport ReactDOM from 'react-dom';\n\nimport { Root, Epic, View, Panel, PanelHeader, Tabbar, TabbarItem, Button, Div, List, SimpleCell } from '@vkontakte/vkui';\nimport Icon28GlobeOutline from '@vkontakte/icons/dist/28/globe_outline';\nimport Icon28ListOutline from '@vkontakte/icons/dist/28/list_outline';\nimport '@vkontakte/vkui/dist/vkui.css';\nimport L from 'leaflet';\n\n//@TODO\n//\n//1. Cделать первые 10 глав книги (отдать ребятам, Яндекс.Толока)\n//2. Кастомизировать popup\n//3. Изменит стиль карты так, чтобы она подстраивалась под размер экрана\n\nvar book = undefined;\nvar book_chapters = [];\n//Процедура загрузки книги\nfunction load_book(str) {\n  book = JSON.parse(str);\n\n  for (var i = 1; i !== book.chapters; i++)\n    book_chapters.push({key: i, value: [book.data[i].name, i, book.data[i].marks, book.data[i].data]});\n\n};\n\nload_book('{\"book_name\": \"Мастер и Маргарита\",\"chapters\": 2,\"data\": {\"1\" : {\"name\": \"Первая глава\",\"marks\": [[\"0\", \"Начало\"],[\"1\", \"Середина\"],[\"2\", \"Конец\"]], \"data\": [[\"mark\", \"0\"],[\"Кот\", [55.7522, 37.6156], 2],[\"Кот\", [55.7622, 37.7156], 4],\t[\"mark\", \"1\"],[\"del\", \"Кот\"],[\"mark\", \"2\"],[\"Мастер\", [55.8522, 37.5956], 3]]},\"2\" : {\"name\": \"Вторая глава\",\"marks\": [[\"0\", \"Начало\"],[\"center\", \"Середина\"],[\"1\", \"Середина\"],[\"end\", \"Конец\"]],\"data\": [[\"mark\", \"0\"],[\"Азазелло\", [55.7522, 37.6156], 2],[\"Бегемот\", [55.7522, 37.6156], 4],\t[\"mark\", \"1\"],[\"del\", \"Бегемот\"],[\"Азазелло\", [55.8522, 37.5956], 3],[\"mark\", \"2\"],[\"del\", \"Азазелло\"]]}} }');\n\nvar popups = [];\n\nvar vwidth = document.documentElement.clientWidth;   //Ширина\nvar vheight = document.documentElement.clientHeight; //Высота Viewport\n\nasync function sleep(ms) {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\nlet mapStyle = { //Структура стиля карты\n  height: vheight - 102,\n  width: vwidth\n};\n\n\nvar curr_point = L.latLng(55.7522, 37.6156); //Текущие координаты карты\nvar curr_z = 14; //Текущее увеличение карты\n\n//Класс карты\nexport default class Map extends React.Component {\n  constructor(props) {\n    super(props);\n\n    this.pause = false;\n    this.persons = {};\n\n    this.play = this.play.bind(this);\n  }\n\n  async play() {\n    var first = true;\n    while (popups.length > 0) {\n      var datablock = popups[0];\n\n      if (datablock[0] === \"del\") {\n        if (datablock[1] in this.persons) {\n          var buf = this.persons[datablock[1]];\n          buf.remove();\n          this.persons[datablock[1]] = undefined;\n        }\n      }\n      else {\n        if (datablock[0] in this.persons && this.persons[datablock[0]] !== undefined)\n          this.persons[datablock[0]].remove();\n\n        var point = L.latLng(datablock[1]);\n        if (!(this.mymap.getBounds().contains(point)) || first)\n          this.mymap.flyTo(point);\n        this.persons[datablock[0]] = L.popup()\n          .setLatLng(point)\n          .setContent(\"<br>\" + datablock[0] + \"<br/>\")\n          .openOn(this.mymap);\n\n        await sleep(datablock[2] * 1000).then()\n        first = false;\n      }\n      \n      popups.shift();\n      if (this.pause)\n        break;\n    };\n  }\n\n  //Рендер DOM\n  render() {\n    return (\n      <div id=\"mapid\" style={mapStyle}></div>\n    );\n  }\n\n  //Вторичный рендер данных карты\n  componentDidMount() {\n    //Создаём объект карты\n    this.mymap = L.map('mapid').setView(curr_point, curr_z).setMaxBounds(L.latLngBounds(L.latLng(56.0, 37), L.latLng(55.5, 38.25)));\n    //Отправляем запрос в Mapbox \n    L.tileLayer(\"https://api.mapbox.com/styles/v1/black-horse/ck9423ydx3ezj1ip93plhxxbb/tiles/{z}/{x}/{y}?access_token={accessToken}\", {\n      minZoom: 10,\n      maxZoom: 17,\n      updateWhenZooming: false,\n      updateWhenIdle: true,\n      bounds: L.latLngBounds(L.latLng(56.25, 35.0), L.latLng(55.25, 39.0)),\n      accessToken: \"pk.eyJ1IjoiYmxhY2staG9yc2UiLCJhIjoiY2thMndiMDg5MDdjMDNsbGt1eHdoYjR6diJ9.z1NmmuGOTudn-b5H5NDtWg\"\n    }).addTo(this.mymap);\n\n    this.play();\n  }\n\n  //Удаление элемента с экрана\n  componentWillUnmount() {\n    //Запоминаем текущие параметры\n    curr_point = this.mymap.getCenter();\n    curr_z = this.mymap.getZoom();\n    //Очищаем память\n    this.mymap = null;\n  }\n}\n\n\nclass App extends React.Component {\n  constructor (props) {\n    super(props);\n\n    this.state = {\n      activeStory: 'map',\n      activeScreen: 'intro',\n      activePanelChapter: 'chapter_select',\n      activeChapter: 1,\n      MarksInChapter: []\n    };\n    this.onStoryChange = this.onStoryChange.bind(this);\n    this.onIntroClick = this.onIntroClick.bind(this);\n    this.onChapterCellClick = this.onChapterCellClick.bind(this);\n    this.onMarkCellClick = this.onMarkCellClick.bind(this);\n  }\n\n  onStoryChange (e) {\n    this.setState({ activeStory: e.currentTarget.dataset.story });\n  }\n\n  onIntroClick (e) {\n    this.setState({ activeScreen: 'things' });\n  }\n\n  onChapterCellClick(e, index) {\n    var buf = [];\n    var i = 0;\n    book_chapters[index - 1].value[2].forEach(mark => {\n      buf.push({key: i, value: mark});\n      ++i;\n    });\n    \n    this.setState({activeChapter: index, MarksInChapter: buf});\n    this.setState({ activePanelChapter: 'mark_select' });\n  }\n\n  onMarkCellClick(e, str) {\n    var mark_id = this.state.MarksInChapter[str].value[0];\n    var found = false;\n\n    book_chapters[this.state.activeChapter - 1].value[3].forEach(element => {\n      if (found && element[0] !== \"mark\") \n        popups.push(element);\n      if (element[0] === \"mark\" && element[1] === mark_id) {\n        found = true;\n      }\n    });\n    this.setState({ activePanelChapter: 'chapter_select', activeStory: 'map'});\n  }\n  render() {\n    return (\n      <Root activeView={this.state.activeScreen}>\n        <View id=\"intro\">         \n          <Div style={{ paddingTop: 60, paddingBottom: 60, color: 'gray' }}>\n            <p style={{textAlign: 'center', verticalAlign: 'middle'}}>Добро пожаловать!</p>\n            <p>Это приложение разработано группой юных аналитиков в рамках проектной деятельности в Академии Калашников. Оно поможет людям, любящим книги и путешествия, узнать побольше о тех местах, \n            где происходили события из книги, и даже пройти по маршрутам её героев. Приложение понятно и легко в использовании.</p>\n            <p>Продукт находится в активной разработке и совсем скоро сможет порадовать интересными новинками! Поэтому обязательно оставляйте обратную связь разработчикам или пишите свои пожелания.</p>\n            <Button size=\"xl\" mode=\"secondary\" onClick={this.onIntroClick}>\n              Продолжить\n            </Button>\n          </Div>\n        </View>\n        <Epic id=\"things\" activeStory={this.state.activeStory} tabbar={\n          <Tabbar>\n            <TabbarItem\n              onClick={this.onStoryChange}\n              selected={this.state.activeStory === 'map'}\n              data-story=\"map\"\n              text=\"Просмотр\"\n            ><Icon28GlobeOutline/></TabbarItem>\n            <TabbarItem\n              onClick={this.onStoryChange}\n              selected={this.state.activeStory === 'chapter'}\n              data-story=\"chapter\"\n              text=\"Главы\"\n            ><Icon28ListOutline/></TabbarItem>\n          </Tabbar>\n        }> \n          <View id=\"map\" activePanel=\"map\">\n            <Panel id=\"map\">\n              <PanelHeader>Карта</PanelHeader>\n              <Map/>\n            </Panel>\n          </View>\n          <View id=\"chapter\" activePanel={this.state.activePanelChapter}>\n            <Panel id=\"chapter_select\">\n              <PanelHeader>Выбор главы</PanelHeader>\n              <List>\n                {Array.prototype.map.call(book_chapters, function (chapter_struct) {\n                  return <SimpleCell expandable onClick={(e) => this.onChapterCellClick(e, chapter_struct.value[1])}>Глава {chapter_struct.value[1]}: {chapter_struct.value[0]}</SimpleCell>;\n                }, this)}\n              </List>\n            </Panel>\n            <Panel id=\"mark_select\">\n              <PanelHeader>Выбор закладки</PanelHeader>\n              <List>\n                {Array.prototype.map.call(this.state.MarksInChapter, function (mark_name) {\n                return <SimpleCell expandble onClick={(e) => this.onMarkCellClick(e, mark_name.value[0])}>{mark_name.value[1]}</SimpleCell>;\n                }, this)}\n              </List>\n            </Panel> \n          </View>\n        </Epic>\n      </Root>\n    )\n  }\n}\n\nReactDOM.render(<App/>, document.getElementById('root'));"],"sourceRoot":""}